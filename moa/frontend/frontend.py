from . import moa

from ..shape import has_symbolic_elements, is_symbolic_element
from ..ast import MOANodeTypes, UnaryNode, BinaryNode


def _determine_function_arguments(symbol_table):
    """Determines function arguments to moa statement based on symbol table

    Behavior:
      - user defined named symbols with unknown shape or values are arguments
      - implicit arrays "<1 2 n>" with unknown values are arguments
    """
    dependent_arguments = set()
    array_arguments = set()

    for symbol_name, symbol_node in symbol_table.items():
        if symbol_name.startswith('_'):
            if symbol_node.shape is None or has_symbolic_elements(symbol_node.shape):
                raise NotImplementedError('cannot have implicit array with unknown shape')
            elif has_symbolic_elements(symbol_node.value):
                for element in symbol_node.value:
                    if is_symbolic_element(element):
                        array_arguments.add(element.symbol_node)
        else: # user defined
            if symbol_node.shape is None:
                array_arguments.add(symbol_name)
            elif has_symbolic_elements(symbol_node.shape):
                array_arguments.add(symbol_name)
                for element in symbol_node.shape:
                    if is_symbolic_element(element):
                        dependent_arguments.add(element.symbol_node)

            if symbol_node.value is None:
                array_arguments.add(symbol_name)
            elif has_symbolic_elements(symbol_node.value):
                array_arguments.add(symbol_name)
                for element in symbol_node.value:
                    if is_symbolic_element(element):
                        dependent_arguments.add(element.symbol_node)
    return array_arguments - dependent_arguments


def parse_statement(statement, frontend='moa'):
    if frontend == 'moa':
        parser = moa.MOAParser()
        symbol_table, tree = parser.parse(statement)
    else:
        raise ValueError(f'frontend "{frontend}" not implemented')

    # inspect function arguments
    symbols = _determine_function_arguments(symbol_table)

    # assignment result = statement

    # return new symbol_table, tree
